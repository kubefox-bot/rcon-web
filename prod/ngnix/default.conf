# -----------------------------------------------------
# üîÅ HTTP Fallback
# –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ—Ç–∫—Ä—ã–ª —Å–∞–π—Ç –±–µ–∑ HTTPS (http://), 
# –º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–º –µ–≥–æ –Ω–∞ https://
# -----------------------------------------------------
server {
    listen 80;  # –°–ª—É—à–∞–µ–º –æ–±—ã—á–Ω—ã–π (–Ω–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π) HTTP
    server_name rcon.example.com;  # üåê –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω!

    location / {
        # 301 ‚Äî –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ HTTPS (–ø–æ—Ä—Ç 8443)
        return 301 https://$host:8443$request_uri;
    }
}

# -----------------------------------------------------
# üîê –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä ‚Äî HTTPS
# –ó–¥–µ—Å—å —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ TLS-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
# -----------------------------------------------------
server {
    listen 8443 ssl;  # –°–ª—É—à–∞–µ–º HTTPS-–ø–æ—Ä—Ç
    server_name rcon.example.com;  # üåê –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω!

    # üìú –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ TLS-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É –∫–ª—é—á—É
    ssl_certificate     /etc/nginx/certs/cert.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;

    # ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –∏ —à–∏—Ñ—Ä—ã (–ø–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    # üß† –ö—ç—à TLS-—Å–µ—Å—Å–∏–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1h;

    # üåç DNS –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–º—ë–Ω (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
    resolver 1.1.1.1 1.0.0.1 valid=300s;
    resolver_timeout 5s;

    # üìÑ –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    access_log /dev/stdout main;
    error_log  /dev/stderr warn;

    # -----------------------------------------------------
    # üîó –ü—Ä–æ–∫—Å–∏ –¥–ª—è API-–∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å /api)
    # -----------------------------------------------------
    location /api/ {
        proxy_pass http://rcon-back:3000;  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -----------------------------------------------------
    # üåê –ü—Ä–æ–∫—Å–∏ –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ ‚Äî —ç—Ç–æ frontend (UI)
    # -----------------------------------------------------
    location / {
        proxy_pass http://rcon-front:4173;  # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ frontend
        proxy_http_version 1.1;

        # –≠—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω—É–∂–Ω—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã WebSocket –∏ –ø—Ä–æ–∫—Å–∏
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞ ‚Äî –æ—Ç–¥–∞—ë–º index.html (–¥–ª—è SPA)
        try_files $uri $uri/ /index.html;
    }
}
