# ==========================
# üß± –ë–∏–ª–¥–µ—Ä-—ç—Ç–∞–ø (–º—É–ª—å—Ç–∏—Å—Ç–µ–π–¥–∂) —Å cargo-chef
# ==========================
FROM rust:1.85-alpine AS chef
RUN apk add --no-cache musl-dev openssl-dev pkgconfig openssl-libs-static curl bash

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cargo-chef (–¥–ª—è –∫—ç—à–∏—Ä—É–µ–º–æ–π —Å–±–æ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
RUN cargo install cargo-chef

# –ö–æ–ø–∏—Ä—É–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω
COPY . .
RUN cargo chef prepare --recipe-path recipe.json

# –°—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ —Ä–µ—Ü–µ–ø—Ç—É
FROM rust:1.85-alpine AS planner
RUN apk add --no-cache musl-dev openssl-dev pkgconfig openssl-libs-static curl bash
WORKDIR /app

RUN cargo install cargo-chef
COPY --from=chef /app/recipe.json recipe.json
COPY . .
RUN cargo chef cook --release --recipe-path recipe.json

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
FROM rust:1.85-alpine AS builder
RUN apk add --no-cache musl-dev openssl-dev pkgconfig openssl-libs-static curl bash
WORKDIR /app

COPY . .
COPY --from=planner /app/target target
COPY --from=planner /usr/local/cargo /usr/local/cargo

RUN cargo build --release --target x86_64-unknown-linux-musl
RUN strip target/x86_64-unknown-linux-musl/release/rcon-api

# ==========================
# üßä –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
# ==========================
FROM alpine:3.21

RUN apk add --no-cache libssl3

COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/rcon-api /usr/local/bin/app

# ‚õî –ù–µ –∫–æ–ø–∏—Ä—É–µ–º .env –≤–Ω—É—Ç—Ä—å –æ–±—Ä–∞–∑–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å–Ω–∞—Ä—É–∂–∏
WORKDIR /app

EXPOSE 3000
CMD ["app"]
